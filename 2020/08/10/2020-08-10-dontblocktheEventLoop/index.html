<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Don't block the event loop | Youmekko</title><meta name="description" content="Don't block the event loop - Youme Choi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="Youmekko"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Youmekko" type="application/atom+xml">
</head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="Youmekko">Youmekko</a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/youmekko" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about" target="_self">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Don't block the event loop</h1><div class="post-info"><a></a>2020-08-10</div><div class="post-content"><ul>
<li>run-to-completion</li>
<li>javascript-engine</li>
<li>call-stack<ul>
<li>ì½”ë“œê°€ ì‹¤í–‰ ë  ë•Œ í˜¸ì¶œ ìŠ¤íƒì´ ìŒ“ì¸ë‹¤.</li>
</ul>
</li>
<li>Web APIs<ul>
<li>dom events</li>
<li>xmlHttpRequest</li>
<li>setTimeout</li>
<li>Promise</li>
<li>requsetAnimationFrame</li>
</ul>
</li>
<li>Event loop<ul>
<li>Event loop manages what task is to be pushed in the Callstack</li>
<li>JSì—”ì§„ì˜ êµ¬ì„± ìš”ì†ŒëŠ” ì•„ë‹ˆë‹¤.</li>
<li>ë¹„ë™ê¸° ë™ì‹œì„±ì„ ì§€ì›í•˜ëŠ” ê²ƒì€ ì—”ì§„ì´ êµ¬ë™ ë˜ëŠ” í™˜ê²½ ë¸Œë¼ìš°ì €ë‚˜ nodejs ì´ë‹¤.</li>
<li>êµ¬ë™í™˜ê²½ì—ì„œ  ì´ë²¤íŠ¸ ë£¨í”„ì— ì–´ë–¤ taskë¥¼ ë°€ì–´ë„£ì„ì§€ ê´€ë¦¬í•˜ëŠ” ì—­í• ì€ í˜¸ì¶œ ìŠ¤íƒì´ í•œë‹¤.</li>
<li>ë™ì‘ ìˆœì„œ<ol>
<li>While there are tasks</li>
<li>excute the oldest task</li>
<li>sleep until a task appears, then go to 1.</li>
</ol>
</li>
</ul>
</li>
</ul>
<p><img src="/img/2020-08-10-01.gif" alt=""></p>
<ul>
<li><p>task vs micro task</p>
<ul>
<li>task<ul>
<li>task than should execute sequentially in browser</li>
<li>source: setTimeout, running script, ui events</li>
</ul>
</li>
<li>micro tasks<ul>
<li>async task that should happne after the currenly executing script</li>
<li>microtask queue has a higher priority than the task queue</li>
<li>source : promise, mutationObserver, process.nextTick</li>
</ul>
</li>
<li>ì‹¤í–‰ ìˆœì„œ ë””í…Œì¼ ë³€ê²½<ol>
<li>if the micro task queue is not empty execute all microtasks</li>
<li>while thre are tasks execute the oldest task</li>
<li>sleep unitl a task appears then go to 1</li>
</ol>
</li>
</ul>
<p><img src="/img/2020-08-10-02.gif" alt=""></p>
</li>
<li><p>Soâ€¦ Can asynchronous JS solve all the problem</p>
<ul>
<li>ì•ì„  taskë¡œ ì¸í•´ì„œ ë‹¤ìŒ taskê°€ ë¸”ë½ ë  ê°€ëŠ¥ì„±ì€ ë‚¨ì•„ ìˆë‹¤.</li>
<li>Task is always executed sequentially by event loop<ul>
<li>other task cannot be performed when any task is running</li>
</ul>
</li>
<li>microtask queue has a higher priority than the task queue<ul>
<li>So, UI-related events cannot be exectued again until all microtasks accumulated in the queue are cleared.</li>
</ul>
</li>
<li>what if long running task stacked tasks or microtasks block event that is directly connected to UI such as rendering, click, input?<ul>
<li>janky UI/UX occursâ€¦ ğŸ‘»</li>
</ul>
</li>
</ul>
<p><img src="/img/2020-08-10-03.gif" alt=""></p>
</li>
<li><p>how to handling this blocking?</p>
<ul>
<li><p>With another threadâ€¦?</p>
<ul>
<li>ë¼ì´í¬ ë©€í‹° ì“°ë ˆë”©?</li>
<li>JSì—ì„œ ë©€í‹°ì“°ë ˆë”©ì€ web worker ë¥¼ í™œìš©í•˜ë©´ ê°€ëŠ¥í•˜ë‹¤.</li>
<li>web workers makes it possible to run a script operation in a background thread sperate from the main execution thread of a web application</li>
<li>ë©”ì¸ì“°ë ˆë“œì—ì„œ ì›Œì»¤ê°ì²´ë¥¼ ìƒì„±í•´ì„œ ì›Œì»¤ì“°ë ˆë“œì™€ ë©”ì„¸ì§€ ê¸°ë°˜ìœ¼ë¡œ í†µì‹ í•  ìˆ˜ ìˆë‹¤.</li>
</ul>
<p><img src="/img/2020-08-10-04.png" alt=""></p>
<p><img src="/img/2020-08-10-05.png" alt=""></p>
<ul>
<li>frameì†Œìš”ì‹œê°„ interaction ì†Œìš”ì‹œê°„ë„ ìƒë‹¹íˆ ì¤„ì¼ ìˆ˜ ìˆë‹¤.</li>
<li>í•˜ì§€ë§Œ ì—­ì‹œ ë²„ë²…ì„ ì—†ëŠ” ì‚¬ìš©ì ê²½í—˜ì„ ì£¼ì§€ëŠ” ëª»í•œë‹¤. (ì˜ˆì œ ì½”ë“œì—ì„œ)</li>
<li>ìš”ì¦˜ ëŒ€ë¶€ë¶„ì˜ ë””ìŠ¤í”Œë ˆì´ ë‹¨ë§ê¸°ê°€ 60fps ( 16m/frame ) ê¸°ì¤€</li>
<li>cpu ë°”ìš´ë“œì˜ ì—°ì‚°ì€ ì›Œì»¤ì“°ë ˆë“œì— ìœ„ì„ì„ í–ˆì§€ë§Œ ë” ê°±ì‹  ë“±ì˜ ì‘ì—…ì€ ë©”ì¸ì“°ë ˆë“œì—ì„œ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì¸ ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.</li>
<li>Web worker Limitaions<ul>
<li>Data is sent between workers and the main thread via a system of messages</li>
<li>Worker cannot access directly the DOM, context (of main thread).</li>
</ul>
</li>
</ul>
</li>
<li><p>split some expensive task into small tasksâ€¦? ì ì ˆí•˜ê²Œ ìª¼ê°œì„œ ì‹¤í–‰í•´ë³´ì</p>
<ul>
<li><p>scheduling</p>
<ul>
<li>slice your heavy task in light sub-tasks and run them asynchronously</li>
<li></li>
</ul>
<p><img src="/img/2020-08-10-06.gif" alt=""></p>
<p><img src="/img/2020-08-10-07.png" alt=""></p>
<p><img src="/img/2020-08-10-08.png" alt=""></p>
<ul>
<li>í”„ë ˆì„ ìµœëŒ€ ì†Œìš”ì‹œê°„ë„ ë§ˆì§€ë§‰ ë”ì„ ê°±ì‹ í•˜ëŠ” ìˆœê°„ì— ì¡°ê¸ˆ ê±¸ë ·ê³  interaction ì†Œìš” ì‹œê°„ë„ ëˆˆì— ë„ê²Œ ì§§ì•„ ì¡Œë‹¤.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Recap"><a href="#Recap" class="headerlink" title="Recap"></a>Recap</h1><ul>
<li>If long-running-tasks or microtasks block rendering, click, and text input, a janky UI that harms user experience can be delivered can occur.</li>
<li>This is due to the structure of the JS engine event-loop, etc. and needsto to understanding and handle properly.</li>
<li>to handle this, Delegate long-running-tasks to toher threads using Web Worker.</li>
<li>Or, split the long-running-tasks properly so that other important UI event do not block.</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a class="next" href="/2020/07/29/2020-07-29-ssh/">next</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'youmekko';
var disqus_identifier = '2020/08/10/2020-08-10-dontblocktheEventLoop/';
var disqus_title = 'Don't block the event loop';
var disqus_url = 'http://yoursite.com/2020/08/10/2020-08-10-dontblocktheEventLoop/';
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>&copy; 2016 - 2020 <a href="https://www.example.org/john-doe" target="_blank" rel="noopener">John Doe</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>